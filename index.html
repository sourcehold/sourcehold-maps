<html>
    <head>
        <script src="localforage.min.js"></script>
        <!--<script src="https://cdn.rawgit.com/SheetJS/js-crc32/master/crc32.js"></script> -->
        <script src="crc32.js"></script>
        <script src="architecture.js"></script>
        <script src="jszip.js"></script>
        <script src="mapexplorer.js"></script>
        <script src="raphael.min.js"></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="numjs.js"></script>
    </head>
    <body>
        <div style="display: flex">
            <div style="display: block">
                <h2 style="float: left;">Map file unpacker</h2>
                <img id="packloader" style="display:none; width: 20px; height: 20px; position: relative; top: 20px; left: 10px;"  src="https://chimplyimage.appspot.com/images/samples/classic-spinner/animatedCircle.gif" />
                
                
            </div>

        </div>
        
        
        <div style="display: flex">
            <div style="flex: 0 0 35%">
                Map file(s): <input type="file" name="mapfile" id="mapfileselect" multiple="multiple"><button onclick="convert_map_to_zip();" type="button" id="converttozip" disabled>Convert to ZIP</button>
            </div>

            <div style="flex: 0 0 65%">
                Zip file(s): <input type="file" name="zipfile" id="zipfileselect" multiple="multiple"><button onclick="convert_zip_to_map();" type="button" id="converttomap" disabled>Convert to MAP</button>
            </div>

            
        </div>

        <br>
        
        <hr>

        <br>

        <div style="display: flex">
            <div style="display: block">
                <h2 style="float: left;">Map tile section explorer</h2>
                <img id="tileexplorerloader" style="display:none; width: 20px; height: 20px; position: relative; top: 20px; left: 10px;"  src="https://chimplyimage.appspot.com/images/samples/classic-spinner/animatedCircle.gif" />
                
            </div>

        </div>

        <div>
            Note: you can also unpack your map file and explore tile sections yourself (a tile data section is usually of size (KB): 79, 158, 315, ...)
            <br>
            <br>
        </div>

        <div style="display: flex">
            <div style="flex: 0 0 20%">
                Select map file: <input type="file" name="tilesectionexplorerfile" id="tilesectionexplorerfileselect" onchange="cache_tile_section_explorer_map()">
            </div>
            <div style="flex: 0 0 20%">
                Choose section: 
                <select name="section_options" id="tile_explorer_section_selection">
                    <option value="1001">1001</option>
                    <option value="1033">1033</option>
                    <option value="1002">1002</option>
                    <option value="1003">1003</option>
                    <option value="1037">1037</option>
                    <option value="1043">1043</option>
                    <option value="1004">1004</option>
                    <option value="1020">1020</option>
                    <option value="1036">1036</option>
                    <option value="1005">1005</option>
                    <option value="1045">1045</option>
                    <option value="1006">1006</option>
                    <option value="1007">1007</option>
                    <option value="1008">1008</option>
                    <option value="1009">1009</option>
                    <option value="1010">1010</option>
                    <option value="1030">1030</option>
                    <option value="1026">1026</option>
                    <option value="1118">1118</option>
                    <option value="1012">1012</option>
                    <option value="1021">1021</option>
                    <option value="1049">1049</option>
                    <option value="1028">1028</option>
                    <option value="1029">1029</option>
                    <option value="1103">1103</option>
                    <option value="1104">1104</option>
                    <option value="1105">1105</option>
                </select>
            </div>
            <div style="flex: 0 0 15%">
                
                <button onclick="load_tilesection();" type="button" id="loadtilesectionexplorersection" disabled>Load/draw/render selected section</button>
            </div>
            <div style="flex: 0 0 15%">
                <input type="checkbox" id="explorer_color_mode" name="color_mode" value="Categorical">
                <label for="explorer_color_mode">Categorical color mode</label><br>
            </div>
        </div>

        <h3 style="display:none;">Rendering options</h3>
        <div style="display: flex; display: none">
            <div style="flex: 0 0 15%">
                Render from row: <input type="number" id="load_tiles_from_row" name="load_tiles_from_row_element" step="1" min=1 max=400 value=0>
            </div>
            <div style="flex: 0 0 15%">
                Render n rows (max 400): <input type="number" id="load_tiles_n_rows" name="load_tiles_n_rows_element" step="1" min=1 max=400 value=40>
            </div>
            <div style="flex: 0 0 15%">
                Tile width: <input type="number" id="load_tiles_tile_width" name="load_tiles_tile_width" step="1" min=1 value=8>
            </div>
            <div style="flex: 0 0 15%">
                Tile height: <input type="number" id="load_tiles_tile_height" name="load_tiles_tile_hight" step="1" min=1 value=4>
            </div>
        </div>

        <div id="tilesectiondisplay">
            <div style="height:100vh;width:100vw;" id="paper">

            </div>
        </div>
        
        <script type="text/javascript">
                (function() {
                    // Key for local storage, use to save and access.
                    var FILE_KEY = 'mapfile';
    
                    // fire processUpload when the user uploads a file.
                    document.querySelector('#mapfileselect').addEventListener('change', handleFileUpload, false);
    
                    // Log any previously saved file.
                    //console.log('previous save: ', retrieveSave());
    
                    // Setup file reading
                    var reader = new FileReader();
                    reader.onload = handleFileRead;
    
                    function handleFileUpload(event) {
                        var file = event.target.files[0];
                        if(document.querySelector('#mapfileselect').files.length > 0) {
                            document.querySelector('#converttozip').removeAttribute('disabled', false);
                        } else {
                            document.querySelector('#converttozip').setAttribute('disabled', true);
                        }
//                        reader.readAsBinaryString(file); // fires onload when done.
                        //localforage.setItem(FILE_KEY, file);
                    }
    
                    function handleFileRead(event) {
                        return localforage.setItem(FILE_KEY, event.target.result);
                    }
    
                    function retrieveSave() {
                        return localforage.getItem(FILE_KEY);
                    }
                })();

                (function() {
                    // Key for local storage, use to save and access.
                    var FILE_KEY = 'zipfile';
    
                    // fire processUpload when the user uploads a file.
                    document.querySelector('#zipfileselect').addEventListener('change', handleFileUpload, false);
    
                    // Log any previously saved file.
                    //console.log('previous save: ', retrieveSave());
    
                    // Setup file reading
                    var reader = new FileReader();
                    reader.onload = handleFileRead;
    
                    function handleFileUpload(event) {
                        var file = event.target.files[0];
                        if(document.querySelector('#zipfileselect').files.length > 0) {
                            document.querySelector('#converttomap').removeAttribute('disabled', false);
                        } else {
                            document.querySelector('#converttomap').setAttribute('disabled', true);
                        }
//                        reader.readAsBinaryString(file); // fires onload when done.
                        //localforage.setItem(FILE_KEY, file);
                    }
    
                    function handleFileRead(event) {
                        return localforage.setItem(FILE_KEY, event.target.result);
                    }
    
                    function retrieveSave() {
                        return localforage.getItem(FILE_KEY);
                    }
                })();

                (function() {
                    // Key for local storage, use to save and access.
                    var FILE_KEY = 'tilesectionfile';
    
                    // fire processUpload when the user uploads a file.
                    document.querySelector('#tilesectionexplorerfileselect').addEventListener('change', handleFileUpload, false);
    
                    // Log any previously saved file.
                    //console.log('previous save: ', retrieveSave());
    
                    // Setup file reading
                    var reader = new FileReader();
                    reader.onload = handleFileRead;
    
                    function handleFileUpload(event) {
                        var file = event.target.files[0];
                        if(document.querySelector('#tilesectionexplorerfileselect').files.length > 0) {
                            document.querySelector('#loadtilesectionexplorersection').removeAttribute('disabled', false);
                        } else {
                            document.querySelector('#loadtilesectionexplorersection').setAttribute('disabled', true);
                        }
//                        reader.readAsBinaryString(file); // fires onload when done.
                        //localforage.setItem(FILE_KEY, file);
                    }
    
                    function handleFileRead(event) {
                        return localforage.setItem(FILE_KEY, event.target.result);
                    }
    
                    function retrieveSave() {
                        return localforage.getItem(FILE_KEY);
                    }
                })();
                
                var download_blob = (function () {
                    var a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";
                    return function (blob, fileName) {
                        var url = window.URL.createObjectURL(blob);
                        a.href = url;
                        a.download = fileName;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    };
                }());
                
                (function() {
                    paper = new Raphael(document.getElementById("paper"), width=1904, height=900);
                    //paper.setViewBox(800, 0, 100, 100, true);


                })()

        </script>
        
        <script type="text/javascript" src="pkware.js"></script>
        <script type="text/javascript" src="packing.js"></script>
    </body>
    
</html>